<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상품 가격 조사</title>
    <style>
        body { font-family: sans-serif; }
        label { display: block; margin-bottom: 5px; }
        input[type="file"], input[type="text"], textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-right: 5px; }
        #logArea { border: 1px solid #ccc; padding: 10px; height: 200px; overflow-y: scroll; white-space: pre-wrap; font-family: monospace;}
        .error { color: red; }
    </style>
</head>
<body>
    <h1>상품 가격 조사</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <label for="fileInput">엑셀 파일 업로드:</label>
        <input type="file" id="fileInput" accept=".xlsx, .xls" required>
        <button type="button" onclick="uploadFile()">파일 업로드</button><br>

        <label for="output_filename">출력 파일명:</label>
        <input type="text" name="output_filename" id="output_filename" value="price_results.xlsx" required> <br>

        <label for="model">모델 선택:</label>
        <select name="model" id="model">
            <option value="sonar">sonar</option>
            <option value="sonar-pro">sonar-pro</option>
        </select><br>

        <label for="system_prompt">System Prompt:</label>
        <textarea name="system_prompt" id="system_prompt" rows="5" cols="60"></textarea><br>

        <!-- System Prompt 업로드/다운로드 버튼 -->
        <button type="button" onclick="uploadPromptFile()">Prompt 파일 업로드</button>
        <button type="button" onclick="downloadPromptFile()">Prompt 파일 다운로드</button>
    </form>

    <button type="button" onclick="startSearch()">조사 시작</button>
    <button id="download-btn" style="display: none;">결과 파일 다운로드</button>

    <h2>진행 상황</h2>
    <pre id="logArea"></pre>

    <script>
        let filePath = null;

        function uploadFile() {
            // ... (이전 코드와 동일) ...
            let formData = new FormData();
            let fileInput = document.getElementById("fileInput");
            formData.append("file", fileInput.files[0]);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                filePath = data.file_path; // 서버에서 반환된 파일 경로 저장
            })
            .catch(error => alert("오류 발생: " + error));
        }

        function startSearch() {
            // ... (이전 코드와 동일) ...
             if (!filePath) {
                alert("먼저 파일을 업로드해주세요.");
                return;
            }
            const outputFilename = document.getElementById("output_filename").value;
            const model = document.getElementById("model").value;
            const systemPrompt = document.getElementById("system_prompt").value;


            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded', // 폼 데이터 형식

                },
                body: `file_path=${encodeURIComponent(filePath)}&output_filename=${encodeURIComponent(outputFilename)}&model=${encodeURIComponent(model)}&system_prompt=${encodeURIComponent(systemPrompt)}`,


            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                 document.getElementById("download-btn").style.display = "inline-block"; // 다운로드 버튼 표시
            })
            .catch(error => alert("오류 발생: " + error));

            startLogStreaming();
        }

        function startLogStreaming() {
            // ... (이전 코드와 동일) ...
            const logArea = document.getElementById("logArea");
            logArea.innerHTML = "검색 진행 중...\n";

            const eventSource = new EventSource('/logs');

            eventSource.onmessage = function(event) {
                logArea.innerHTML += event.data;
                logArea.scrollTop = logArea.scrollHeight;
            };

            eventSource.onerror = function(event) {
                console.error("EventSource failed:", event);
                eventSource.close();
            };
        }
        // system prompt 업로드
        function uploadPromptFile() {
            let formData = new FormData();
            let promptFileInput = document.getElementById("promptFileInput"); // id 변경
            formData.append("prompt_file", promptFileInput.files[0]);

            fetch('/upload_prompt', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Prompt 파일 업로드 오류: " + data.error);
                } else {
                    document.getElementById("system_prompt").value = data.prompt;
                    alert(data.message);
                }
            })
            .catch(error => alert("Prompt 파일 업로드 오류: " + error));
        }

        // system prompt 다운로드
        function downloadPromptFile() {
            const systemPrompt = document.getElementById("system_prompt").value;
            // encodeURIComponent 불필요 (이미 텍스트)
            window.location.href = `/download_prompt?prompt_content=${systemPrompt}`;
        }

        document.getElementById("download-btn").addEventListener("click", function() {
            window.location.href = "/download";
        });
    </script>
    <input type="file" id="promptFileInput" accept=".txt" style="display: none;">
</body>
</html>
